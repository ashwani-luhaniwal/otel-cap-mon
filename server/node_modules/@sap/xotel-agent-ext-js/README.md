[![Build Status](https://gkepasswd.jaas-gcp.cloud.sap.corp/buildStatus/icon?style=flat-square&job=xdsr%2Fxotel-agent-ext-js%2Fmain)](https://gkepasswd.jaas-gcp.cloud.sap.corp/job/xdsr/job/xotel-agent-ext-js/job/main/)
[![node](https://img.shields.io/badge/xotel--agent--ext--js-1.5.2-blue?style=flat-square)](https://int.repositories.cloud.sap/)
[![Quality Gate Status](https://sonar.tools.sap/api/project_badges/measure?project=xotel-agent-ext-js&metric=alert_status&token=b1016d1fb431987b575ae8b863dc10a4d7edf252)](https://sonar.tools.sap/dashboard?id=xotel-agent-ext-js)
[![Maintainability Rating](https://sonar.tools.sap/api/project_badges/measure?project=xotel-agent-ext-js&metric=sqale_rating&token=b1016d1fb431987b575ae8b863dc10a4d7edf252)](https://sonar.tools.sap/dashboard?id=xotel-agent-ext-js)
[![Security Rating](https://sonar.tools.sap/api/project_badges/measure?project=xotel-agent-ext-js&metric=security_rating&token=b1016d1fb431987b575ae8b863dc10a4d7edf252)](https://sonar.tools.sap/dashboard?id=xotel-agent-ext-js)
[![Coverage](https://sonar.tools.sap/api/project_badges/measure?project=xotel-agent-ext-js&metric=coverage&token=b1016d1fb431987b575ae8b863dc10a4d7edf252)](https://sonar.tools.sap/dashboard?id=xotel-agent-ext-js)

# xotel-agent-ext-js

This is an extension for the OpenTelemetry Node.js auto instrumentation that propagates SAP Passport as well as W3C Trace Context and exports the resulting traces to the SAP CALM Data Collector Runtime (DCR)

## Setup

In package.json:

```json
{
     "dependencies": {
        "@sap/xotel-agent-ext-js" : "^1.5.2"
     },
}
```

## Configuration
For deployment, there are several configuration environment parameters:
### For SaaS
* `SAP_CALM_SERVICE_NAME` (arbitrary name of your application)
* `SAP_CALM_SERVICE_TYPE` (your CLD service type, e.g. SAP_CP_CF)
* `SAP_CALM_POLL_DC` (cloud Provider data center as in CLD e.g. XAF, ROT etc...)
* `OTEL_POLL_INTERVAL` (Time interval duration in seconds for configuration polling)
* `OTEL_RESOURCE_ATTRIBUTES` (key-value-pairs of additional attributes)

For example in `mta.yaml` this can look like this:

```yaml
modules:
  - name: <srv module name>
    properties:
      SAP_CALM_SERVICE_NAME: <application name>
      SAP_CALM_SERVICE_TYPE: <your CLD service type, e.g. SAP_CP_CF>
      SAP_CALM_POLL_DC: <your CLD data center e.g. XAF, ROT etc...>
      OTEL_POLL_INTERVAL: <POLL interval in seconds e.g 300>
      OTEL_RESOURCE_ATTRIBUTES: account=<arbitrary identifier of application in SAP CALM>
```

### For PaaS
* `SAP_CALM_SERVICE_NAME` (arbitrary name of your application)
* `OTEL_POLL_INTERVAL` (Time interval duration in seconds for configuration polling)
* `OTEL_RESOURCE_ATTRIBUTES` (key-value-pairs of additional attributes)
* Optional: `OTEL_RESOURCE_ATTRIBUTES=sap.tenancy.tenant_id=<your provider subaccount id>` (will force the instrumentation to report the data for the given provider tenant)

For example in `mta.yaml` this can look like this:

```yaml
modules:
  - name: <srv module name>
    properties:
      SAP_CALM_SERVICE_NAME: <application name>
      OTEL_POLL_INTERVAL: <POLL interval in seconds e.g 300>
      OTEL_RESOURCE_ATTRIBUTES: account=<arbitrary identifier of application in SAP CALM>,sap.tenancy.tenant_id=<your provider subaccount id>
```

If you are using an mta application make sure that node modules and the `package-lock.json` are included in your `mtar`:

```yaml
modules:
  - name: <your srv module>
    type: nodejs
    path: gen/srv
    build-parameters:
      builder: npm
      ignore:
        # - node_modules
        # - package-lock.json
```

In some cases your mta build setup might copy the built resources to specific folder, e.g. `gen/srv`. If the node_modules and package-lock.json are not present in this folder we need to tell the mbt command to add these as well:

```yaml
build-parameters:
  before-all:
    - builder: custom
      commands:
        - npm install --production
        - ...
        - npm install --prefix ./gen/srv
```
### otel.resource.attributes

| Name |  Description |
| ----------- |  ----------- |
| account | Name of your product |
| sap.tenancy.tenant_id | Your provider subaccount id. will force the instrumentation to report the data for the given provider tenant |

### Instrumentation settings

The following environment variables can be set to configure the behavior of the instrumentation

| Name |  Description |
| ----------- |  ----------- |
| SAP_CALM_DCI_AGG_THRESHOLD | Optional - Threshold in ms for RUM spans to be aggregated (default: 100, i.e. all spans with a response time lower than 100ms will be aggregated and grouped by action, request, user, span type and span kind) |
| SAP_CALM_DCI_AGG_USER | Optional - Specify whether user ids shall be aggregated for RUM spans (default: true) |

## Setup at source code level

On application startup load the above mentioned instrumentation:

```javascript
const tracer = require('@sap/xotel-agent-ext-js/dist/common/tracer');
```

> ❗ **_NOTE:_**  require the tracer before you initialize your application. Otherwise the auto-instrumentation will not work.
> However, for some applications this will still not be sufficient. In such cases we recommend to initialize the application as a callback 
> of the auto-instrumentation:

```javascript
const tracer = require('@sap/xotel-agent-ext-js/dist/common/tracerCallback')(() => {
  // initialize your application here
})
```

## Setup at deployment level

Require the tracer via node arguments in the `mta.yaml` file:

```yaml
modules:
  - name: <your srv module>
    type: nodejs
    properties:
      NODE_ARGS: -r @sap/xotel-agent-ext-js/dist/common/tracer
```

In the `package.json` file of your project modify the start script to pick up the required tracer.

For regular node applications:

```json
{
  "scripts": {
    "start": "node ${NODE_ARGS} <main file name>.js"
  }
}
```

For CAP based applications with `@sap/cds` < 7:

```json
{
  "scripts": {
    "start": "node ${NODE_ARGS} ./node_modules/@sap/cds/bin/cds run"
  }
}
```

For CAP based applications with `@sap/cds` >= 7:

```json
{
  "scripts": {
    "start": "node ${NODE_ARGS} ./node_modules/@sap/cds/bin/cds-serve"
  }
}
```

## Disabling auto instrumentation

If you want to disable the auto instrumentation (e.g. in case of an emergency) you can do this by setting the environment variable:

```shell
SAP_CALM_INSTRUMENTATION_ENABLED=false
```

### Tracing

If you only want to disable the tracing auto instrumentation you can set

```shell
SAP_CALM_TRACING_ENABLED=false
```

### Metrics

If you only want to disable the metrics auto instrumentation you can set

```shell
SAP_CALM_METRICS_ENABLED=false
```

---
## Logging

Log level can be specified via the the `SAP_CALM_DCI_LOG_LEVEL` environment variable, e.g.

```
SAP_CALM_DCI_LOG_LEVEL=debug
```
---
## Manual Instrumentation (Client library)

For manual instrumentation of spans, the usecases need to extend the abstract class ```IUseCasedata``` and use the below require load and ```sendCrunContent()``` to send usecase content for exporting to the DCR.

```javascript
const CrunInstrumentation = require('@sap/xotel-agent-ext-js/dist');
CrunInstrumentation.sendCrunContent(usecase_data :IUsecaseData, service_type, tenant_id) : Promise
```
---
### Authentication

### Service Bindings
In order to export towards DCR one has to setup the destination to DCR via Certificate/ OAuth based authentication, depending upon the destination type.

* Bind to Destination Service
* Add the below lines to mta.yaml

 ```yaml
 modules:
 - name: otel-instrumentation
   requires:
    - name: <destination-service-name>
resources:
  - name: <destination-service-name>
    parameters:
      service-plan: lite
      service: destination
    type: org.cloudfoundry.managed-service
 ```

 ## DCR Endpoints
 - Configure the URL in destination configuration for different landscapes as below
 ```
DEV  => https://dev.<datacenter>.alm.cloud.sap/api
TEST => https://test.<datacenter>.alm.cloud.sap/api
PROD => https://<datacenter>.alm.cloud.sap/api

E.g If datacenter is `eu10` and landscape is `dev` the endpoint that must be configured in destination configuration is `https://dev.eu10.alm.cloud.sap/api` 
 ```

### Certificate based authentication
#### For Cloud Provisions as SaaS scenario
- Create a destination configuration using Destination Service for storing the baseUrl 
- Create the entry with Authentication as `NoAuthentication`
- The Destination endpoint will be formed dynamically by retrieving the baseUrl from Destination.
- The Destination name should be in the format `CALM_datacollector_<space-name>`. Agent will check with destination with space name, otherewise, will fallback to check for default destination as without space```CALM_datacollector``` 
- The `<space-name>` is the space where the microservice has to be  deployed.
- If the microservice is in space `xyz`, the destination configuration name can be `CALM_datacollector_xyz`

```
curl --location --request POST 'https://<destination-service-baseUrl>/destination-configuration/v1/subaccountDestinations/' \
--header 'Authorization: Bearer <token>' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-raw '{
    "Name": "CALM_datacollector_<space-name>",
    "Type": "HTTP",
    "URL": "https://dev.eu10.alm.cloud.sap/api",
    "Authentication": "NoAuthentication",
    "ProxyType": "Internet",
    "Description": "CALM_datacollector_endpoint"
}'
```

### OAuth based authentication
#### For Cloud Provisions as PaaS scenario ( Customer-Extension )
- Create a destination configuration using Destination Service for persisting the baseUrl and retrieving it. 
- The Destination endpoint should be formed dynamically by retrieving the baseUrl from Destination.
- The Destination name should be in the format `CALM_datacollector_<space-name>`. Agent will check with destination with space name, otherewise, will fallback to check for default destination as without space```CALM_datacollector``` 
- The `<space-name>` is the space where the microservice has to be deployed. 
- If the microservice is in space "xyz", the destination configuration name can be `CALM_datacollector_xyz`
```
curl --location --request POST 'https://destination-configuration.cfapps.eu10.hana.ondemand.com/destination-configuration/v1/subaccountDestinations' \
--header 'Authorization: Bearer <access_token>' \
--header 'Content-Type: application/json' \
--data-raw '{
        "Name": "CALM_datacollector_<space-name>",
        "Type": "HTTP",
        "URL": "https://dev.eu10.alm.cloud.sap/api",
        "Authentication": "OAuth2ClientCredentials",
        "ProxyType": "internet",
        "clientId": "<client-id>",
        "clientSecret": "<client-secret>",
        "tokenServiceURL": "<token-service-url>"
    },'
```

## Exposed API to get Configurations by use case

Usecases can get tenant level configurations for servicetype and usecase combination through exposed GET API ```getConfigurationsByUsecase()```.
<br>
Syntax:
```js
CrunInstrumentation.getConfigurationByUsecase(usecase)
  .then(response => {
    // Returns: Promise<hashmap> 
    // KEY: tenant ids : string
    // VALUE: configurations : Object
    // for a given servicetype-usecase
  })
```

